<include file="public/head"/>
<div class="ncsc-layout wrapper">
  <include file="public/left"/>
  <div id="layoutRight" class="ncsc-layout-right">
    <div class="ncsc-path"><i class="icon-desktop"></i>商家管理中心<i class="icon-angle-right"></i>订单物流<i class="icon-angle-right"></i>发货列表</div>
    <div class="main-content" id="mainContent">
      
<div class="tabmenu">
  <ul id="tab" class="tab pngFix">
  	<li class="<if condition='$Request.param.shipping_status eq 0'>active</if>" data-val="0"><a  href="#">待发货{$Request.param.shipping_status}</a></li>
  	<li class="normal  <if condition='$Request.param.shipping_status eq 2'>active</if>" data-val="2"><a  href="#">部分发货</a></li>
  	<li class="normal <if condition='$Request.param.shipping_status eq 1'>active</if>" data-val="1"><a  href="#">已发货{$Request.param.shipping_status}</a></li>
  	<if condition="$Request.action eq 'supplierDeliveryList' OR $Request.action eq 'supplierReturnList'">
  		<li class="normal" ><a href="{:U('Service/supplierReturnList')}">已退换货</a></li>
  	<else />
	  	<li class="normal" ><a href="{:U('Service/return_list')}">已退换货</a></li>
	</if>
  </ul>
  </div>
  <div class="alert alert-block mt10">
	  <ul class="mt5">
	    <li>1、发货列表包含"待发货"、"部分发货"、"已发货"三个状态</li>
	    <li>2、待发货订单可发货, 部分发货订单可继续发货, 已发货订单可打印发货单</li>
	    <li>3、已经发货订单, 如果买家没有确认收货, 系统会根据设置结算周期自动结算订单</li>
	  </ul>
</div>
<form method="post" action="{:U('Order/ajaxdelivery')}" id="search-form2" onsubmit="return false">
  <input type="hidden" name="shipping_status" id="shipping_status" value="{$Request.param.shipping_status}">
  <input type="hidden" name="seller_order_type" id="seller_order_type" value="{$seller_order_type?:'1'}">
  <table class="search-form">
    <tr>
      <th>收货人</th>
      <td class="w120"><input type="text" class="text w150" name="consignee" placeholder="收货人" value=""/></td>
      <th>订单编号</th>
      <td class="w120"><input type="text" class="text w150" name="order_sn" placeholder="订单编号" value=""/></td>
      <th>下单时间</th>
      <td class="w340">
	      <input type="text" class="text w120" name="start_time" id="start_time" placeholder="开始时间" value="{$begin}"/>&nbsp;&#8211;&nbsp;
	      <input type="text" class="text w120" name="end_time" id="end_time" placeholder="结束时间" value="{$end}"/>
	   </td>
	   <td class="w70 tc"><label class="submit-border"><input type="button" onclick="ajax_get_table('search-form2',1)" class="submit" value="搜索" /></label></td>


     </tr>
  </table>
</form>

<div style="margin-top:8px;margin-bottom:-6px;float:left;margin-left:8px;">
<input id="all" type="checkbox" value="" title="全选" />
</div>


<div id="fh" style="margin-top:6px;margin-bottom:-6px;float:left;margin-left:25px">
<a id="S2" href="javascript:void(0)"  class="ncbtn-mini" title="批量发货" style="background-color:#48CFAE">批量发货</a>
</div>


<div id="kd" style="margin-top:6px;margin-bottom:-6px;float:left;margin-left:25px;display:none">
<a id="S3" href="javascript:void(0)"  class="ncbtn-mini" title="批量发货" style="background-color:#48CFAE">批量打印快递单</a>
</div>

<div style="margin-top:6px;margin-bottom:-6px;float:left;margin-left:25px">
<a id="S1" href="javascript:void(0)" class="ncbtn-mini" title="批量发货" style="background-color:#48CFAE">批量打印配货单</a>
</div>

<div id="ajax_return">

</div>
<script>
$(document).ready(function(){	  
 	$('#start_time').layDate();
 	$('#end_time').layDate();
 	 
 	ajax_get_table('search-form2',1);
 	
 	$("#tab > li").each(function(){
		$(this).click(function(){
			console.log($(this).attr('data-val'));
			if($(this).attr('data-val')==0){
				$('#fh').show();
				$('#kd').hide();
			}else{
				$('#fh').hide();
			}

			if($(this).attr('data-val')==1){
				$('#kd').show();
				$('#fh').hide();
			}else{
				$('#kd').hide();
			}

			tabSelect(this);
		});
	});
});

var tmp=0;
$("#all").click(function(){
	if(tmp==0){
		$("input[type='checkbox']").attr("checked","true");
		tmp=1;
	}else{
		$("input[type='checkbox']").removeAttr("checked"); 
		tmp=0;
	}
}) 

var url3='{:U("Order/order_print_pl")}';
$("#S1").click(function(){ 
  var ids='';
  $("input[type='checkbox']:checkbox:checked").each(function(){ 
    ids+=$(this).val()+',';
  }) 
  if(!ids){
  	layer.msg('未选择订单', {icon: 2, time: 1000});
  	return false;
  }

  url3+='/ids/'+ids+'/template/picking';
  window.open(url3); 
}) 

var url='{:U("Order/send_show")}';
$("#S2").click(function(){ 
	var ids='';
	$("input[type='checkbox']:checkbox:checked").each(function(){ 
	ids+=$(this).val()+',';
	}) 

    if(!ids){
  	  layer.msg('未选择订单', {icon: 2, time: 1000});
  	  return false;
    }
    url+='/ids/'+ids;
	layer.open({
	    type: 2,
	    title: '批量发货',
	    shadeClose: true,
	    shade: 0.5,
	    area: ['50%', '70%'],
	    // skin: 'layui-layer-rim',
	    content: [url],
	});
}) 

//回调函数
function call_back(msg){
		layer.closeAll('iframe');
		window.location.reload();
}

$("#S3").click(function(){
	var url2='{:U("Order/shipping_print_batch")}'; 
	var ids='';
	$("input[type='checkbox']:checkbox:checked").each(function(){ 
	ids+=$(this).val()+',';
	}) 
	
	url2+='/ids/'+ids;
	window.location.href=url2;
}) 


function tabSelect(obj){
	var currHasClass = $(obj).hasClass('active');
	if(currHasClass)return;
	
	$("#tab > li").each(function(){
		$(this).removeClass('active');
	});
	
	$(obj).addClass('active');
	var shippingStatus = $(obj).attr("data-val");
	 
	$("#shipping_status").val(shippingStatus);
	ajax_get_table('search-form2',1);
}

//ajax 抓取页面
function ajax_get_table(tab,page,listRows=20){
    var start_time = $.trim($('#start_time').val());
    var end_time =  $.trim($('#end_time').val());
    if(start_time == '' ^ end_time == ''){
        layer.alert('请选择完整的时间间隔', {icon: 2});
        return false;
    }
    cur_page = page; //当前页面 保存为全局变量
        $.ajax({
            type : "POST",
            url:"/index.php/Seller/order/ajaxdelivery/p/"+page+"/listRows/"+listRows,//+tab,
            data : $('#'+tab).serialize(),// 你的formid
            success: function(data){
                $("#ajax_return").html('');
                $("#ajax_return").append(data);
            }
        });
}

    // 起始位置日历控件
	$('#start_time').layDate(); 
    $('#end_time').layDate();
	laydate({
	  elem: '#start_time',
	  format: 'YYYY-MM-DD', // 分隔符可以任意定义，该例子表示只显示年月
	  festival: true, //显示节日
	  istime: false,
	  choose: function(datas){ //选择日期完毕的回调
		 compare_time($('#start_time').val(),$('#end_time').val());
	  }
	});
	 
	 // 结束位置日历控件
	laydate({
	  elem: '#end_time',
	  format: 'YYYY-MM-DD', // 分隔符可以任意定义，该例子表示只显示年月
	  festival: true, //显示节日
	  istime: false,
	  choose: function(datas){ //选择日期完毕的回调
		   compare_time($('#start_time').val(),$('#end_time').val());
	  }
	});	 
</script>    
</div>
  </div>
</div>
<include file="public/foot"/>
</body>
</html>
